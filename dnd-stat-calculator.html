<!DOCTYPE html>
<html>

<body>
</div>
<!--     <div id="controls" class="flex-container row space-between">
        <div class="flex-container col control-section" style="flex: 1 1 content;">
            <label>Pick One or More Roll Modifier</label>
            <select id="rollAdjustmentSelect" multiple></select>
            <div id="control-section-inputs"></div>
        </div>
        <div class="flex-container col control-section" style="flex: 1 1 content;">
            <label>Output Formatter</label>
            <select id="outputSelect"></select>
        </div>
        <div class="flex-container col  control-section" style="flex: 1 1 content;">
            <button id="rollButton">Roll</button>
            <label for="rollValue">Roll</label>
            <input id="rollValue" readonly></input>
            <label for="average">Average</label>
            <input id="average" readonly></input>
        </div>
    </div> 
    <div id="chart_div" style="width: 100%; height: 50%;"></div>
-->
    <div class="flex-container col space-between">
        <div id="controls" class="flex-container col space-between">
            <div class="flex-container col control-section">
                <label>Pick One or More Roll Modifier</label>
                <select id="rollAdjustmentSelect" multiple style="width: 100%"></select>
                <div id="control-section-inputs"></div>
            </div>
            <div class="flex-container col control-section">
                <label>Output Formatter</label>
                <select id="outputSelect"></select>
            </div>
            <div class="flex-container col  control-section">
                <button id="rollButton">Roll</button>
                <label for="rollValue">Roll</label>
                <input id="rollValue" readonly></input>
                <label for="average">Average</label>
                <input id="average" readonly></input>
            </div>
        </div>
        <div id="chart_div"></div>
    </div>
</body>

<head>
    <title>dnd stat calculator</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript">
    var chartsDrawnAlready = false;
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawChart);

    const rollAdjustments = {
        "advantage": { "method": (roll) => Math.max(roll, randomRoll()), "UIElement": null },
        "disadvantage": { "method": (roll) => Math.min(roll, randomRoll()), "UIElement": null },
        "minimum roll 10": { "method": (roll) => (roll < 10 ? 10 : roll), "UIElement": null },
        "add # d# dice": {
            "method": (roll) => {
                const numDiceInputValue = getNumDiceElement()?.value;
                const sidesInputValue = getSidesElement()?.value;
                const dropLowestInputValue = getDropLowestElement()?.value;
                let rolls = [];
                if (!!numDiceInputValue) {
                    const numDice = parseInt(numDiceInputValue);
                    let sides = parseInt(sidesInputValue);
                    sides = isNaN(sides) ? undefined : sides;
                    for (var i = 0; i < numDice; i++) {
                        rolls.push(randomRoll(sides));
                    }
                }
                if (!!dropLowestInputValue && dropLowestInputValue == true) {
                    rolls.sort((a, b) => a - b).pop();
                }
                return roll;
            },
            "UIElement": "xdy-container",
            "UITemplate": ` <div id="xdy-container" class="flex-container row">
                                <div>
                                    <label for="num-dice-input"># Dice</label>
                                    <input id="num-dice-input" type="number" class="number-input"></input>
                                </div>
                                <div>
                                    <label for="sides-input"># Sides</label>
                                    <input id="sides-input" type="number"></input>
                                </div>
                                <div>
                                    <label for="drop-lowest-input">Drop Lowest</label>
                                    <input id="drop-lowest-input" type="checkbox">
                                </div>
                            </div>`
        },
        "add to roll": {
            "method": (roll) => {
                const addToRollInputValue = getAddToRollElement().value;
                if (!!addToRollInputValue) {
                    return roll + parseInt(addToRollInputValue);
                }
                return roll;
            },
            "UIElement": "add-to-roll-container",
            "UITemplate": ` <div id="add-to-roll-container" class="flex-container row">
                                <div>
                                    <label for="add-to-roll-input">Add To Roll</label>
                                    <input id="add-to-roll-input" type="number"></input>
                                </div>
                            </div>`
        },
    };

    const outputConverters = { 
        "percent": (stats, numAttempts) => {
            return stats.map(roll => [roll[0], roll[1]/numAttempts])
        },
        "likelihood Roll This or Higher": (stats, numAttempts) => {
            const percentData = outputConverters.percent(stats, numAttempts);
            return percentData.map((d, idx) => [d[0], percentData.slice(idx).reduce((acc, curr) => acc + curr[1], 0)])
        },
        "likelihood Roll Higher": (stats, numAttempts) => {
            const percentData = outputConverters.percent(stats, numAttempts);
            return percentData.map((d, idx) => [d[0], percentData.slice(idx+1).reduce((acc, curr) => acc + curr[1], 0)])
        },
        "likelihood Roll Higher": (stats, numAttempts) => {
            const percentData = outputConverters.percent(stats, numAttempts);
            return percentData.map((d, idx) => [d[0], percentData.slice(idx+1).reduce((acc, curr) => acc + curr[1], 0)])
        },
        "likelihood Roll Lower": (stats, numAttempts) => {
            const percentData = outputConverters.percent(stats, numAttempts);
            return percentData.reverse().map((d, idx) => [d[0], percentData.slice(idx+1).reduce((acc, curr) => acc + curr[1], 0)]).reverse()
        },
    };
    // initialization
    getRollAdjustmentElement = () => document.querySelector("#rollAdjustmentSelect");
    getOutputElement = () => document.querySelector("#outputSelect");
    getNumDiceElement = () => document.querySelector("#num-dice-input");
    getAddToRollElement = () => document.querySelector("#add-to-roll-input");
    getDropLowestElement = () => document.querySelector("#sides-input");
    getSidesElement = () => document.querySelector("#drop-lowest-input");
    (() =>{
        Object.keys(rollAdjustments).forEach(adjustment => {
            var selected =  ["add # d# dice", "add to roll"].includes(adjustment) ? true : false;
            getRollAdjustmentElement().options.add(new Option(adjustment, adjustment, selected, selected))
        });
        setupControlInputs();
        Object.keys(outputConverters).forEach(converter => getOutputElement().options.add(new Option(converter, converter)));
    })();


    function drawChart() {
        chartsDrawnAlready = true;
        // build data
        const stats = simulateRolls();
        const dataArray =[["roll", "chance"], ...stats];
        // setup
        var data = google.visualization.arrayToDataTable(dataArray);
        var view = new google.visualization.DataView(data);
        var options = {
            bar: { groupWidth: "95%" },
            legend: { position: "none" },
        };
        // create chart
        var chart = new google.visualization.ColumnChart(document.getElementById("chart_div"));
        chart.draw(view, options);
    }

    function simulateRolls() {
        const numAttempts = 100000;
        const stats = createEmptyRollResults();
        let sum = 0;
        for (var i = 0; i < numAttempts; i++) {
            let roll = randomRoll();
            // const adjustedRoll = (roll < 10 ? 10 : roll) + 7;
            const adjustedRoll = applyRollAdjustments(roll);
            sum += adjustedRoll;
            stats[adjustedRoll] += 1
        }
        document.querySelector("#average").value = (sum/numAttempts).toFixed(2);
        // const percentStats = outputConverters.percent(rollStats, numAttempts);
        // const likelihoodThisRollOrHigher = outputConverters.likelihoodThisRollOrHigher(percentStats);
        // return likelihoodThisRollOrHigher;
        return convertOutput(stats, numAttempts);
    }

    function applyRollAdjustments(roll) {
        const selectedAdjustment = Array.from(getRollAdjustmentElement().selectedOptions).map(opt => opt.value);
        selectedAdjustment.forEach(adjustment => {
            roll = rollAdjustments[adjustment].method(roll)
        });
        return roll;
    }

    function convertOutput(statsObject, numAttempts) {
        const statsArray = Object.keys(statsObject)
            .map(roll => [roll, statsObject[roll]])
            .sort((a,b) => {
                return parseInt(a[0]) - parseInt(b[0])
            });
        const converter = getOutputElement().value;
        return outputConverters[converter](statsArray, numAttempts);
    }

    function createEmptyRollResults() {
        return { "-5":0, "-4":0, "-3":0, "-2":0, "-1":0, "0":0, "1":0, "2":0, "3":0, "4":0, "5":0, "6":0, "7":0, "8":0, "9":0, "10":0, "11":0, "12":0, "13":0, "14":0, "15":0, "16":0, "17":0, "18":0, "19":0, "20":0, "21":0, "22":0, "23":0, "24":0, "25":0, "26":0, "27":0, "28":0, "29":0, "30":0, "31":0, "32":0, "33":0, "34":0, "35":0, "36":0, "37":0};
    }

    function randomRoll(sides = 20) {
        return Math.floor(Math.random() * sides) + 1;
    } 

    function setupControlInputs() {
        document.querySelector("#control-section-inputs").innerHTML = "";
        const selectedAdjustments = Array.from(getRollAdjustmentElement().selectedOptions).map(opt => opt.value);
        Object.keys(rollAdjustments).forEach(key => {
            const adj = rollAdjustments[key];
            if (!!adj.UIElement && selectedAdjustments.includes(key)) {
                document.querySelector("#control-section-inputs").innerHTML += `${adj.UITemplate}\n`;
                // setup listeners, find all ids of all inputs in the UITemplate and add listener
                const inputIDs = [...adj.UITemplate.matchAll(/id="[a-z\-]*-input/g)].map(ele => ele[0].replace(`id="`, ""));
                // TODO: when multiple templates are added, only the last template's event listener is kept
                inputIDs.forEach(inputID => document.querySelector(`#${inputID}`).addEventListener("change", (event) => drawChart()));
            }
        });
    }

    // listeners
    window.addEventListener('resize', drawChart);
    getRollAdjustmentElement().addEventListener("change", (event) => {
        setupControlInputs();
        drawChart();
    });
    getOutputElement().addEventListener("change", (event) => drawChart());
    document.querySelector("#rollButton").addEventListener("click", (event) => {
        const initialRoll = randomRoll();
        let rollValue = applyRollAdjustments(initialRoll);
        rollValue = rollValue != initialRoll ? `${rollValue} (${initialRoll})` : rollValue.toString(); 
        document.querySelector("#rollValue").value = rollValue;
    });
    </script>
</head>

<body>
</body>

</html>